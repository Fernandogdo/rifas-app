<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">

  <!-- Header / KPIs -->
  <div class="flex flex-col gap-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Órdenes</h1>
        <p class="text-sm text-slate-500">Administra y revisa órdenes, estados de pago y asignaciones.</p>
      </div>

      <!-- Selector de Vista -->
      <div class="inline-flex rounded-xl ring-1 ring-slate-200 bg-white p-1">
        <button type="button"
                (click)="groupMode.set('none')"
                class="px-3 py-1.5 rounded-lg text-sm"
                [class.bg-slate-900]="groupMode()==='none'"
                [class.text-white]="groupMode()==='none'">
          Tabla
        </button>
        <button type="button"
                (click)="groupMode.set('date')"
                class="px-3 py-1.5 rounded-lg text-sm"
                [class.bg-slate-900]="groupMode()==='date'"
                [class.text-white]="groupMode()==='date'">
          Agrupar por día
        </button>
        <button type="button"
                (click)="groupMode.set('rifa')"
                class="px-3 py-1.5 rounded-lg text-sm"
                [class.bg-slate-900]="groupMode()==='rifa'"
                [class.text-white]="groupMode()==='rifa'">
          Agrupar por rifa
        </button>
      </div>
    </div>

    <!-- KPIs de la vista actual (página filtrada) -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
      <div class="rounded-2xl border border-slate-200 bg-white p-3">
        <div class="text-[11px] text-slate-500">Pendientes</div>
        <div class="text-xl font-semibold text-slate-900">{{ kpis().pendiente }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-3">
        <div class="text-[11px] text-slate-500">Pagadas</div>
        <div class="text-xl font-semibold text-slate-900">{{ kpis().pagado }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-3">
        <div class="text-[11px] text-slate-500">Asignadas</div>
        <div class="text-xl font-semibold text-slate-900">{{ kpis().asignado }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-3">
        <div class="text-[11px] text-slate-500">Canceladas</div>
        <div class="text-xl font-semibold text-slate-900">{{ kpis().cancelado }}</div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-3">
        <div class="text-[11px] text-slate-500">Monto (vista)</div>
        <div class="text-xl font-semibold text-slate-900">$ {{ kpis().monto | number:'1.2-2' }}</div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">

      <!-- Chips estado (rápido) -->
      <div class="lg:col-span-5">
        <div class="text-xs font-medium text-slate-600 mb-2">Estado</div>
        <div class="flex flex-wrap gap-2">
          <button type="button" (click)="onEstadoChange('todas')"
                  class="px-3 py-1.5 rounded-xl text-sm ring-1 ring-slate-200"
                  [class.bg-slate-900]="estado()==='todas'"
                  [class.text-white]="estado()==='todas'">Todos</button>
          <button type="button" (click)="onEstadoChange('pendiente')"
                  class="px-3 py-1.5 rounded-xl text-sm ring-1 ring-slate-200"
                  [class.bg-slate-900]="estado()==='pendiente'"
                  [class.text-white]="estado()==='pendiente'">Pendiente</button>
          <button type="button" (click)="onEstadoChange('pagado')"
                  class="px-3 py-1.5 rounded-xl text-sm ring-1 ring-slate-200"
                  [class.bg-slate-900]="estado()==='pagado'"
                  [class.text-white]="estado()==='pagado'">Pagado</button>
          <button type="button" (click)="onEstadoChange('asignado')"
                  class="px-3 py-1.5 rounded-xl text-sm ring-1 ring-slate-200"
                  [class.bg-slate-900]="estado()==='asignado'"
                  [class.text-white]="estado()==='asignado'">Asignado</button>
          <button type="button" (click)="onEstadoChange('cancelado')"
                  class="px-3 py-1.5 rounded-xl text-sm ring-1 ring-slate-200"
                  [class.bg-slate-900]="estado()==='cancelado'"
                  [class.text-white]="estado()==='cancelado'">Cancelado</button>
        </div>
      </div>

      <!-- Autocompletar de Rifa -->
      <div class="lg:col-span-4">
        <label class="block text-xs font-medium text-slate-600 mb-1">Rifa</label>
        <div class="relative">
          <input
            [ngModel]="rifaSearch()"
            (ngModelChange)="onRifaSearch($event)"
            (focus)="rifaSuggestOpen.set(true)"
            (blur)="onRifaBlur()"
            [ngModelOptions]="{standalone: true}"
            type="text"
            placeholder="Busca por título de rifa…"
            class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30" />

          @if (rifaSuggestOpen() && rifaOptions().length > 0) {
            <ul class="absolute z-10 mt-1 w-full rounded-xl border border-slate-200 bg-white shadow-lg max-h-64 overflow-auto">
              @for (opt of rifaOptions(); track opt.id) {
                <li>
                  <button type="button"
                          (mousedown)="$event.preventDefault()"
                          (click)="selectRifa(opt)"
                          class="w-full text-left px-3 py-2 text-sm hover:bg-slate-50">
                    <div class="font-medium text-slate-800">{{ opt.titulo }}</div>
                    <div class="text-[11px] text-slate-500 truncate">{{ opt.id }}</div>
                  </button>
                </li>
              }
            </ul>
          }
        </div>
        @if (rifa()) {
          <div class="mt-2 inline-flex items-center gap-2 text-xs">
            <span class="rounded-lg bg-slate-100 px-2 py-1">{{ titleFor(rifa()) }}</span>
            <button type="button" class="text-slate-500 hover:text-slate-700" (click)="clearRifa()">
              Limpiar
            </button>
          </div>
        }
      </div>

      <!-- Email + Por página -->
      <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Email comprador</label>
          <input
            [ngModel]="email()"
            (ngModelChange)="onEmailChange($event)"
            [ngModelOptions]="{standalone: true}"
            type="email"
            placeholder="correo@dominio.com"
            class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30" />
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Por página</label>
          <select [ngModel]="limit()" (ngModelChange)="onLimitChange($event)" [ngModelOptions]="{standalone: true}"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
            <option [ngValue]="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Estados -->
  @if (error()) {
    <div class="rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm">
      {{ error() }}
    </div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="space-y-2">
      <div class="h-10 rounded-xl bg-slate-200 animate-pulse"></div>
      <div class="h-10 rounded-xl bg-slate-200 animate-pulse"></div>
      <div class="h-10 rounded-xl bg-slate-200 animate-pulse"></div>
    </div>
  }

  <!-- Tabla / Agrupaciones -->
  @if (!loading() && data().items.length > 0) {
    <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-3 font-medium">Orden</th>
            <th class="text-left px-4 py-3 font-medium">Rifa</th>
            <th class="text-left px-4 py-3 font-medium">Email</th>
            <th class="text-left px-4 py-3 font-medium">Cant.</th>
            <th class="text-left px-4 py-3 font-medium">Total</th>
            <th class="text-left px-4 py-3 font-medium">Estado</th>
            <th class="text-left px-4 py-3 font-medium">Creada</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>

        <tbody>
          <!-- Vista plana -->
          @if (groupMode()==='none') {
            @for (o of data().items; track o.id) { @defer (when true) {
              <tr class="border-t border-slate-100">
                <td class="px-4 py-3"><div class="font-medium text-slate-800 truncate max-w-[200px]">{{ o.id }}</div></td>
                <td class="px-4 py-3">
                  <div class="text-slate-800">{{ titleFor(o.rifaId) }}</div>
                  <div class="text-[11px] text-slate-500 truncate max-w-[220px]">{{ o.rifaId }}</div>
                </td>
                <td class="px-4 py-3">{{ o.compradorEmail }}</td>
                <td class="px-4 py-3">{{ o.cantidad }}</td>
                <td class="px-4 py-3">$ {{ o.total | number:'1.2-2' }}</td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
                        [ngClass]="badgeClass(o.estado)">
                    {{ o.estado }}
                  </span>
                </td>
                <td class="px-4 py-3">{{ o.createdAt | date:'yyyy-MM-dd HH:mm' }}</td>
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <button type="button" (click)="openDetail(o)"
                            class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                      Ver detalle
                    </button>
                    <a [routerLink]="['/admin/rifas', o.rifaId]"
                       class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                      Ver rifa
                    </a>
                  </div>
                </td>
              </tr>
            } }
          }

          <!-- Agrupado por día -->
          @if (groupMode()==='date') {
            @for (g of groupsByDate(); track g.key) {
              <tr class="bg-slate-50/60 border-t border-slate-100">
                <td colspan="8" class="px-4 py-2 text-[13px] font-medium text-slate-700">
                  {{ g.label }} · {{ g.items.length }} orden(es)
                </td>
              </tr>
              @for (o of g.items; track o.id) {
                <tr class="border-t border-slate-100">
                  <td class="px-4 py-3"><div class="font-medium text-slate-800 truncate max-w-[200px]">{{ o.id }}</div></td>
                  <td class="px-4 py-3">
                    <div class="text-slate-800">{{ titleFor(o.rifaId) }}</div>
                    <div class="text-[11px] text-slate-500 truncate max-w-[220px]">{{ o.rifaId }}</div>
                  </td>
                  <td class="px-4 py-3">{{ o.compradorEmail }}</td>
                  <td class="px-4 py-3">{{ o.cantidad }}</td>
                  <td class="px-4 py-3">$ {{ o.total | number:'1.2-2' }}</td>
                  <td class="px-4 py-3">
                    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
                          [ngClass]="badgeClass(o.estado)">
                      {{ o.estado }}
                    </span>
                  </td>
                  <td class="px-4 py-3">{{ o.createdAt | date:'yyyy-MM-dd HH:mm' }}</td>
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                      <button type="button" (click)="openDetail(o)"
                              class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                        Ver detalle
                      </button>
                      <a [routerLink]="['/admin/rifas', o.rifaId]"
                         class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                        Ver rifa
                      </a>
                    </div>
                  </td>
                </tr>
              }
            }
          }

          <!-- Agrupado por rifa -->
          @if (groupMode()==='rifa') {
            @for (g of groupsByRifa(); track g.key) {
              <tr class="bg-slate-50/60 border-t border-slate-100">
                <td colspan="8" class="px-4 py-2 text-[13px] font-medium text-slate-700">
                  {{ titleFor(g.key) }} · {{ g.items.length }} orden(es)
                  <span class="text-[12px] text-slate-500 ml-2">({{ g.key }})</span>
                </td>
              </tr>
              @for (o of g.items; track o.id) {
                <tr class="border-t border-slate-100">
                  <td class="px-4 py-3"><div class="font-medium text-slate-800 truncate max-w-[200px]">{{ o.id }}</div></td>
                  <td class="px-4 py-3">
                    <div class="text-slate-800">{{ titleFor(o.rifaId) }}</div>
                    <div class="text-[11px] text-slate-500 truncate max-w-[220px]">{{ o.rifaId }}</div>
                  </td>
                  <td class="px-4 py-3">{{ o.compradorEmail }}</td>
                  <td class="px-4 py-3">{{ o.cantidad }}</td>
                  <td class="px-4 py-3">$ {{ o.total | number:'1.2-2' }}</td>
                  <td class="px-4 py-3">
                    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
                          [ngClass]="badgeClass(o.estado)">
                      {{ o.estado }}
                    </span>
                  </td>
                  <td class="px-4 py-3">{{ o.createdAt | date:'yyyy-MM-dd HH:mm' }}</td>
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                      <button type="button" (click)="openDetail(o)"
                              class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                        Ver detalle
                      </button>
                      <a [routerLink]="['/admin/rifas', o.rifaId]"
                         class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                        Ver rifa
                      </a>
                    </div>
                  </td>
                </tr>
              }
            }
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Empty -->
  @if (!loading() && data().items.length === 0) {
    <div class="rounded-2xl border border-slate-200 bg-white p-10 text-center">
      <div class="mx-auto mb-3 h-10 w-10 rounded-2xl bg-slate-100"></div>
      <h3 class="text-slate-800 font-medium">No hay órdenes</h3>
      <p class="text-sm text-slate-500">Cambia los filtros o vuelve más tarde.</p>
    </div>
  }

  <!-- Paginación -->
  @if (!loading() && data().items.length > 0) {
    <div class="flex items-center justify-between">
      <div class="text-sm text-slate-500">
        Página {{ page() }} de {{ totalPages() }} — {{ data().total }} resultados
      </div>
      <div class="flex items-center gap-2">
        <button (click)="prev()" [disabled]="page() <= 1"
                class="rounded-xl px-3 py-1.5 text-sm ring-1 ring-slate-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
          Anterior
        </button>
        <button (click)="next()" [disabled]="page() >= totalPages()"
                class="rounded-xl px-3 py-1.5 text-sm ring-1 ring-slate-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
          Siguiente
        </button>
      </div>
    </div>
  }

  <!-- MODAL DETALLE (igual que el tuyo, con el fix de d?.asignaciones) -->
  @if (showDetail()) {
    <div class="fixed inset-0 z-50 bg-black/40 backdrop-blur-[1px]" (click)="closeDetail()"></div>

    <div class="fixed inset-0 z-50 flex items-center justify-center p-4" (keydown.escape)="closeDetail()">
      <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl ring-1 ring-slate-900/10" role="dialog"
           aria-modal="true" (click)="$event.stopPropagation()">

        <div class="border-b border-slate-100 px-5 py-4">
          <h3 class="text-lg font-semibold text-slate-900">Detalle de orden</h3>
          <p class="text-xs text-slate-500">Revisa el estado, el pago y los números asignados.</p>
        </div>

        <div class="px-5 py-4 space-y-4">
          @if (detailError()) {
            <div class="rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm">
              {{ detailError() }}
            </div>
          }

          @if (detailLoad()) {
            <div class="h-40 rounded-xl bg-slate-100 animate-pulse"></div>
          } @else if (detail()) {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="rounded-xl border border-slate-200 p-4">
                <div class="text-xs text-slate-500 mb-1">Orden</div>
                <div class="font-medium text-slate-800 break-all">{{ detail()!.id }}</div>

                <div class="mt-3 text-xs text-slate-500 mb-1">Rifa</div>
                <div class="font-medium text-slate-800">{{ detail()!.rifa?.titulo || detail()!.rifaId }}</div>

                <div class="mt-3 text-xs text-slate-500 mb-1">Email</div>
                <div class="font-medium text-slate-800">{{ detail()!.compradorEmail }}</div>
              </div>

              <div class="rounded-xl border border-slate-200 p-4">
                <div class="text-xs text-slate-500 mb-1">Estado</div>
                <div>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
                        [ngClass]="badgeClass(detail()!.estado)">
                    {{ detail()!.estado }}
                  </span>
                </div>

                <div class="mt-3 text-xs text-slate-500 mb-1">Monto</div>
                <div class="font-medium text-slate-800">
                  $ {{ detail()!.total | number:'1.2-2' }} (x{{ detail()!.cantidad }})
                </div>

                <div class="mt-3 text-xs text-slate-500 mb-1">Creada</div>
                <div class="font-medium text-slate-800">{{ detail()!.createdAt | date:'yyyy-MM-dd HH:mm' }}</div>
              </div>
            </div>

            <div class="rounded-xl border border-slate-200 p-4">
              <div class="text-sm font-medium text-slate-800 mb-2">Números asignados</div>

              @let d = detail();

              @if ((d?.asignaciones?.length ?? 0) > 0) {
                <div class="flex flex-wrap gap-2">
                  @for (a of (d?.asignaciones ?? []); track a.id) {
                    <span class="inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-medium ring-1 ring-slate-200">
                      #{{ a.numero }}
                    </span>
                  }
                </div>
              } @else {
                <div class="text-sm text-slate-500">Sin asignaciones.</div>
              }
            </div>
          }
        </div>

        <div class="flex items-center justify-end gap-2 border-t border-slate-100 px-5 py-4">
          <button type="button" (click)="closeDetail()"
                  class="rounded-xl px-3 py-2 text-sm ring-1 ring-slate-200 hover:bg-slate-50">
            Cerrar
          </button>

          @if (detail() && detail()!.estado === 'pendiente') {
            <button type="button" (click)="devMarkPaid()" [disabled]="detailLoad()"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50">
              Marcar como pagada (DEV)
            </button>
          }
        </div>
      </div>
    </div>
  }
</div>
