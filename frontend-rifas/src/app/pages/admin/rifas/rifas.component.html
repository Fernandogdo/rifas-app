<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">

  <!-- Header / Toolbar -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">Rifas</h1>
      <p class="text-sm text-slate-500">Administra rifas: crear, publicar, cerrar y monitorear progreso.</p>
    </div>

    <div class="flex items-center gap-2">
      <!-- Abrir modal de creación -->
      <button type="button"
              (click)="openCreate()"
              class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 shadow-sm">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nueva rifa
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
    <div class="flex flex-col md:flex-row gap-3 md:items-end">
      <div class="flex-1">
        <label class="block text-xs font-medium text-slate-600 mb-1">Buscar</label>
        <input
          [ngModel]="search()"
          (ngModelChange)="onSearchChange($event)"
          [ngModelOptions]="{standalone: true}"
          type="text"
          placeholder="Título o descripción…"
          class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30" />
      </div>

      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">Estado</label>
        <select
          [ngModel]="estado()"
          (ngModelChange)="onEstadoChange($event)"
          [ngModelOptions]="{standalone: true}"
          class="rounded-xl border border-slate-300 px-3 py-2 text-sm">
          <option value="todas">Todas</option>
          <option value="borrador">Borrador</option>
          <option value="publicada">Publicada</option>
          <option value="agotada">Agotada</option>
          <option value="cerrada">Cerrada</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium text-slate-600 mb-1">Por página</label>
        <select
          [ngModel]="limit()"
          (ngModelChange)="onLimitChange($event)"
          [ngModelOptions]="{standalone: true}"
          class="rounded-xl border border-slate-300 px-3 py-2 text-sm">
          <option [ngValue]="10">10</option>
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Estados -->
  @if (error()) {
    <div class="rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm">
      {{ error() }}
    </div>
  }

  <!-- Skeleton loading -->
  @if (loading()) {
    <div class="space-y-2">
      <div class="h-10 rounded-xl bg-slate-200 animate-pulse"></div>
      <div class="h-10 rounded-xl bg-slate-200 animate-pulse"></div>
      <div class="h-10 rounded-xl bg-slate-200 animate-pulse"></div>
    </div>
  }

  <!-- Tabla -->
  @if (!loading() && data().items.length > 0) {
    <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-4 py-3 font-medium">Rifa</th>
            <th class="text-left px-4 py-3 font-medium">Precio</th>
            <th class="text-left px-4 py-3 font-medium">Stock</th>
            <th class="text-left px-4 py-3 font-medium">% Vendido</th>
            <th class="text-left px-4 py-3 font-medium">Estado</th>
            <th class="text-left px-4 py-3 font-medium">Creada</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody>
          @for (r of data().items; track r.id) {
            <tr class="border-t border-slate-100">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <img [src]="imgSrc(r)" alt="" class="h-12 w-12 rounded-lg object-cover ring-1 ring-slate-200" />
                  <div>
                    <div class="font-medium text-slate-800">{{ r.titulo }}</div>
                    <div class="text-xs text-slate-500 truncate max-w-[340px]">{{ r.descripcion }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">$ {{ r.precioUnitario | number:'1.2-2' }}</td>
              <td class="px-4 py-3">{{ r.stockAsignado }} / {{ r.stockTotal }}</td>
              <td class="px-4 py-3">
                <div class="w-36">
                  <div class="h-2 rounded-full bg-slate-200">
                    <div class="h-2 rounded-full bg-slate-900" [style.width.%]="soldPct(r)"></div>
                  </div>
                  <div class="mt-1 text-xs text-slate-600">{{ soldPct(r) }}%</div>
                </div>
              </td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
                      [ngClass]="badgeClass(r.estado)">
                  {{ r.estado || '—' }}
                </span>
              </td>
              <td class="px-4 py-3">{{ r.createdAt ? (r.createdAt | date:'yyyy-MM-dd HH:mm') : '-' }}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <a (click)="gotoPublic(r)"
                     class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">Ver público</a>

                  <!-- Editar abre modal -->
                  <button type="button" (click)="openEdit(r)"
                          class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium ring-1 ring-slate-200 hover:bg-slate-50">
                    Editar
                  </button>

                  @if (r.estado !== 'publicada') {
                    <button (click)="publicar(r)"
                            class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-emerald-600 text-white hover:bg-emerald-700">
                      Publicar
                    </button>
                  } @else {
                    <button (click)="cerrar(r)"
                            class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-amber-600 text-white hover:bg-amber-700">
                      Cerrar
                    </button>
                  }

                  <button (click)="eliminar(r)"
                          class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-rose-600 text-white hover:bg-rose-700">
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Empty state -->
  @if (!loading() && data().items.length === 0) {
    <div class="rounded-2xl border border-slate-200 bg-white p-10 text-center">
      <div class="mx-auto mb-3 h-10 w-10 rounded-2xl bg-slate-100"></div>
      <h3 class="text-slate-800 font-medium">No hay rifas</h3>
      <p class="text-sm text-slate-500">Crea tu primera rifa para comenzar a vender.</p>
      <button type="button"
              (click)="openCreate()"
              class="mt-4 inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 shadow-sm">
        Nueva rifa
      </button>
    </div>
  }

  <!-- Paginación -->
  @if (!loading() && data().items.length > 0) {
    <div class="flex items-center justify-between">
      <div class="text-sm text-slate-500">
        Página {{ page() }} de {{ totalPages() }} — {{ data().total }} resultados
      </div>
      <div class="flex items-center gap-2">
        <button (click)="prev()" [disabled]="page() <= 1"
                class="rounded-xl px-3 py-1.5 text-sm ring-1 ring-slate-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
          Anterior
        </button>
        <button (click)="next()" [disabled]="page() >= totalPages()"
                class="rounded-xl px-3 py-1.5 text-sm ring-1 ring-slate-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
          Siguiente
        </button>
      </div>
    </div>
  }

  <!-- MODAL EDITAR -->
  @if (showEdit()) {
    <!-- Overlay -->
    <div class="fixed inset-0 z-50 bg-black/40 backdrop-blur-[1px]"
         (click)="closeEdit()"
         (keydown.escape)="closeEdit()"></div>

    <!-- Panel -->
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
         (keydown.escape)="closeEdit()">
      <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl ring-1 ring-slate-900/10"
           role="dialog" aria-modal="true" aria-labelledby="edit-title"
           (click)="$event.stopPropagation()">
        <div class="border-b border-slate-100 px-5 py-4">
          <h3 id="edit-title" class="text-lg font-semibold text-slate-900">Editar rifa</h3>
          <p class="text-xs text-slate-500">Actualiza los datos y guarda los cambios.</p>
        </div>

        <form (submit)="saveEdit($event)">
          <div class="px-5 py-4 space-y-4">

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Título</label>
              <input id="edit-titulo"
                     [ngModel]="edit().titulo"
                     (ngModelChange)="updateEdit('titulo', $event)"
                     [ngModelOptions]="{standalone: true}"
                     type="text"
                     class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"
                     required />
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Descripción</label>
              <textarea
                     [ngModel]="edit().descripcion"
                     (ngModelChange)="updateEdit('descripcion', $event)"
                     [ngModelOptions]="{standalone: true}"
                     rows="3"
                     class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Precio</label>
                <input
                  [ngModel]="edit().precioUnitario"
                  (ngModelChange)="updateEdit('precioUnitario', $event)"
                  [ngModelOptions]="{standalone: true}"
                  type="number" step="0.01" min="0"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"
                  required />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Stock total</label>
                <input
                  [ngModel]="edit().stockTotal"
                  (ngModelChange)="updateEdit('stockTotal', $event)"
                  [ngModelOptions]="{standalone: true}"
                  type="number" step="1" min="1"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"
                  required />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Estado</label>
                <select
                  [ngModel]="edit().estado"
                  (ngModelChange)="updateEdit('estado', $event)"
                  [ngModelOptions]="{standalone: true}"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                  <option value="borrador">Borrador</option>
                  <option value="publicada">Publicada</option>
                  <option value="agotada">Agotada</option>
                  <option value="cerrada">Cerrada</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Imagen (URL)</label>
              <input
                [ngModel]="edit().mediaUrl"
                (ngModelChange)="updateEdit('mediaUrl', $event)"
                [ngModelOptions]="{standalone: true}"
                type="url"
                placeholder="https://..."
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30" />
              <p class="mt-1 text-[11px] text-slate-500">Usa la primera imagen como portada.</p>
            </div>

          </div>

          <div class="flex items-center justify-end gap-2 border-t border-slate-100 px-5 py-4">
            <button type="button"
                    (click)="closeEdit()"
                    class="rounded-xl px-3 py-2 text-sm ring-1 ring-slate-200 hover:bg-slate-50">
              Cancelar
            </button>
            <button type="submit"
                    [disabled]="!isEditValid() || saving()"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50">
              @if (saving()) { <span class="h-4 w-4 animate-spin rounded-full border-2 border-white/30 border-t-white"></span> }
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- MODAL CREAR -->
  @if (showCreate()) {
    <!-- Overlay -->
    <div class="fixed inset-0 z-50 bg-black/40 backdrop-blur-[1px]"
         (click)="closeCreate()"
         (keydown.escape)="closeCreate()"></div>

    <!-- Panel -->
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4"
         (keydown.escape)="closeCreate()">
      <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl ring-1 ring-slate-900/10"
           role="dialog" aria-modal="true" aria-labelledby="create-title"
           (click)="$event.stopPropagation()">
        <div class="border-b border-slate-100 px-5 py-4">
          <h3 id="create-title" class="text-lg font-semibold text-slate-900">Nueva rifa</h3>
          <p class="text-xs text-slate-500">Completa los datos para crear la rifa.</p>
        </div>

        <form (submit)="saveCreate($event)">
          <div class="px-5 py-4 space-y-4">

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Título</label>
              <input id="create-titulo"
                     [ngModel]="create().titulo"
                     (ngModelChange)="updateCreate('titulo', $event)"
                     [ngModelOptions]="{standalone: true}"
                     type="text"
                     class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"
                     required />
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Descripción</label>
              <textarea
                     [ngModel]="create().descripcion"
                     (ngModelChange)="updateCreate('descripcion', $event)"
                     [ngModelOptions]="{standalone: true}"
                     rows="3"
                     class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Precio</label>
                <input
                  [ngModel]="create().precioUnitario"
                  (ngModelChange)="updateCreate('precioUnitario', $event)"
                  [ngModelOptions]="{standalone: true}"
                  type="number" step="0.01" min="0"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"
                  required />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Stock total</label>
                <input
                  [ngModel]="create().stockTotal"
                  (ngModelChange)="updateCreate('stockTotal', $event)"
                  [ngModelOptions]="{standalone: true}"
                  type="number" step="1" min="1"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30"
                  required />
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Estado</label>
                <select
                  [ngModel]="create().estado"
                  (ngModelChange)="updateCreate('estado', $event)"
                  [ngModelOptions]="{standalone: true}"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                  <option value="borrador">Borrador</option>
                  <option value="publicada">Publicada</option>
                  <option value="agotada">Agotada</option>
                  <option value="cerrada">Cerrada</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Imagen (URL)</label>
              <input
                [ngModel]="create().mediaUrl"
                (ngModelChange)="updateCreate('mediaUrl', $event)"
                [ngModelOptions]="{standalone: true}"
                type="url"
                placeholder="https://..."
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500/30" />
              <p class="mt-1 text-[11px] text-slate-500">Usa la primera imagen como portada.</p>
            </div>

          </div>

          <div class="flex items-center justify-end gap-2 border-t border-slate-100 px-5 py-4">
            <button type="button"
                    (click)="closeCreate()"
                    class="rounded-xl px-3 py-2 text-sm ring-1 ring-slate-200 hover:bg-slate-50">
              Cancelar
            </button>
            <button type="submit"
                    [disabled]="!isCreateValid() || saving()"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50">
              @if (saving()) { <span class="h-4 w-4 animate-spin rounded-full border-2 border-white/30 border-t-white"></span> }
              Crear rifa
            </button>
          </div>
        </form>
      </div>
    </div>
  }

</div>
